# Malware analysis

CAF Spoki Evaluation, Version 2


## Dependencies

* Python3
* Python3 Virtualenvironments
* Kafka
  * Java

On Ubuntu 20.04.2 LTS, python3 is verison 3.8, here you can run:

```
$ sudo apt install python3.8-dev python3.8-venv openjdk-11-jdk
```

## Kafka

Malware processing uses Kafka for communication between processes. You can setup Kafka and Zookeeper as system services or just run them directly [as follows](https://kafka.apache.org/quickstart). (Since you need multiple processes running, `screen` or `tmux` can make the multiplexing easier.)


```
$ wget https://www.apache.org/dyn/closer.cgi?path=/kafka/3.0.0/kafka_2.13-3.0.0.tgz
$ tar -xzf kafka_2.13-3.0.0.tgz
$ cd kafka_2.13-3.0.0
$ # Start the ZooKeeper service in one tab.
$ bin/zookeeper-server-start.sh config/zookeeper.properties
# Start the Kafka broker service in another tab.
$ bin/kafka-server-start.sh config/server.properties
```

## Setup

Requires python 3. The development setup will link executables into the virtual environment and make them easily accessible for development.

```
$ # Setup a virtual environment.
$ python3 -m venv envs
$ source envs/bin/activate
$ # Now install the requires packges.
$ make update
$ # You might need to call this twice because the first run only install pip-tools.
$ make update
```



## Running

Once you got that running, the malware scripts can be started. They should each write (and read) from a Kafka topic.

*Note:*
- The date should be the date at which the processing starts.
- The hour should be the hour at which processing starts.
- The `LOG_DIR` is the folder with Spoki's logs.
- The programs `filter`, `clean`, and `download` can read from multiple topics and produce to a single new topic. `-c` sets a tag for the topic to consume from and `-p` sets the tag for the topic to produce to.

Example: ...

```
$ assemble -s 2021-08-16 -H 12 -d test -P 600 --kafka --csv LOG_DIR
$ filter -c test -p test
$ clean -c test -p test
$ download -c test
```

The script `reset-topics -d test` resets the data in the local Kafka instance for the tag `test`.

